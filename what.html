<?php
// π 视觉小说 — 完整单文件（pi_vn_full.php）
// 包含：Module 1-8 基础与 Module 13（剧情脚本+分支+回忆债务）整合版
// 说明：保存为 pi_vn_full.php 后可直接放到支持 PHP 的服务器打开（部分占位资源需替换）

$pi_block = "14159265358979323846264338327950288419716939937510"; // 50 digits
$PI10000 = str_repeat($pi_block, 200); // 10000 digits
$PI10000_JS = str_replace("\n","", $PI10000);
?>
<!doctype html>
<html lang="zh">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>π里的第762位是你 — 完整版</title>
<style>
/* Simple styles for VN */
body{margin:0;background:#000;color:#0f0;font-family:monospace;overflow:hidden}
#app{width:100vw;height:100vh;position:relative}
#bg-layer{position:absolute;inset:0;background:#001;transition:opacity .6s}
#char-layer{position:absolute;inset:0;pointer-events:none}
.char{position:absolute;image-rendering:pixelated;transition:opacity .3s}
#ui{position:absolute;left:0;right:0;bottom:0;padding:20px;background:linear-gradient(180deg,rgba(0,0,0,0.4),rgba(0,0,0,0.8));box-sizing:border-box}
#nameBox{font-weight:700;color:#ffd48a}
#textBox{min-height:120px;white-space:pre-wrap;font-size:18px;line-height:1.6}
.choice-btn{display:inline-block;padding:8px 12px;margin:6px;border:1px solid #0f0;cursor:pointer}
.choice-btn:hover{background:#0f0;color:#000}
#nextIndicator{position:absolute;right:22px;bottom:12px;opacity:.6}
</style>
</head>
<body>
<div id="app">
  <div id="bg-layer"></div>
  <div id="char-layer"></div>
  <div id="ui">
    <div id="nameBox"></div>
    <div id="textBox">（加载中）</div>
    <div id="choices"></div>
    <div id="nextIndicator">▶</div>
  </div>
</div>

<script>
// PI data
window.PI10000 = "<?php echo $PI10000_JS;?>";

// VN core (a light version of Module8)
const VN = {
  bg:document.getElementById('bg-layer'),
  charLayer:document.getElementById('char-layer'),
  nameBox:document.getElementById('nameBox'),
  textBox:document.getElementById('textBox'),
  choices:document.getElementById('choices'),
  nextIndicator:document.getElementById('nextIndicator'),
  isTyping:false, allowNext:false, currentScript:[], scriptIndex:0, flags:{}, chars:{},
  setBG(path){ VN.bg.style.opacity=0; setTimeout(()=>{ VN.bg.style.backgroundImage = path?`url(${path})`:'none'; VN.bg.style.opacity=1; },220); },
  registerChar(name,conf){ VN.chars[name]={...conf,elem:null,visible:false}; },
  showChar(name){ const c=VN.chars[name]; if(!c) return; if(!c.elem){ const img=document.createElement('img'); img.src=c.base64||''; img.className='char'; img.style.width=(c.w||160)+'px'; img.style.left=(c.x||50)+'%'; img.style.top=(c.y||60)+'%'; img.style.opacity=0; VN.charLayer.appendChild(img); c.elem=img; } c.elem.style.left=(c.x||50)+'%'; c.elem.style.top=(c.y||60)+'%'; c.elem.style.opacity=1; c.visible=true; },
  hideChar(name){ const c=VN.chars[name]; if(c&&c.elem) c.elem.style.opacity=0; c.visible=false; },
  typeText(text,cb){ VN.isTyping=true; VN.allowNext=false; VN.textBox.innerText=''; let i=0; const speed=28; const t=setInterval(()=>{ VN.textBox.innerText+=text.charAt(i++); VN.textBox.scrollTop=VN.textBox.scrollHeight; if(i>=text.length){ clearInterval(t); VN.isTyping=false; VN.allowNext=true; if(cb) cb(); } }, speed); },
  showChoices(list){ VN.choices.innerHTML=''; VN.allowNext=false; list.forEach(c=>{ const b=document.createElement('div'); b.className='choice-btn'; b.innerText=c.text; b.onclick=()=>{ VN.choices.innerHTML=''; c.action(); }; VN.choices.appendChild(b); }); },
  runLine(line){ if(!line) return; if(line.bg) VN.setBG(line.bg); if(line.show) VN.showChar(line.show); if(line.hide) VN.hideChar(line.hide); VN.nameBox.innerText=line.name||''; if(line.choices){ VN.showChoices(line.choices); return; } VN.typeText(line.text||''); },
  next(){ if(VN.isTyping||!VN.allowNext) return; if(VN.scriptIndex>=VN.currentScript.length) return; const line=VN.currentScript[VN.scriptIndex++]; VN.runLine(line); },
  start(script){ VN.currentScript=script; VN.scriptIndex=0; VN.next(); }
};

// click to advance
document.body.addEventListener('click', ()=>{ VN.next(); });

// ========== Register placeholder characters (pixel base64 placeholders) ==========
VN.registerChar('零',{x:60,y:65,w:160,base64:'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAACCAYAAACZgbYnAAAAEklEQVQIW2P8z8BQz0AEYBxVSFQAALwIC5n0nQwAAAAASUVORK5CYII='});
VN.registerChar('e',{x:22,y:68,w:140,base64:'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAACCAYAAACZgbYnAAAAEklEQVQIW2P8z8BQz0AEYBxVSFQAALwIC5n0nQwAAAAASUVORK5CYII='});
VN.registerChar('Phi',{x:88,y:68,w:160,base64:'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAACCAYAAACZgbYnAAAAEklEQVQIW2P8z8BQz0AEYBxVSFQAALwIC5n0nQwAAAAASUVORK5CYII='});

// ========= Full Script Integration (condensed full story per your spec) =========
const fullScript = [
  // PROLOGUE — Chapter 0: 引子 · 数字之外的声音 (extended)
  { text: '世界寂静如冻结的宇宙背景辐射。你站在一片纯黑之中，脚下没有地面，头顶没有天空，数字以你从未见过的规律流动。' },
  { text: '一串绿色字符在虚空中亮起：
3.1415926535 8979323846 2643383279 5028841971 ... 光点像呼吸般闪动，数字以生命的节奏跳动。' },
  { text: '数字扭曲，低语像数学结构的呻吟：
“……谁……在试图解读我？””' },
  { text: '光影中出现三名存在：Zero（零）、e（欧拉数化身）、Phi（黄金比的守护者）。他们将引你进入“数域”。' },

  // Chapter 1: 第一万位的门槛（extended）
  { text: '你猛然睁开——身处一座巨大的钟楼内部，齿轮由数字构成，空气有电流嗡鸣。一个面板上写着：
π 查询进度：0 / 10000 位' },
  { text: 'Zero 靠在由质数堆砌的柱子上，神情淡然：
“你查询每一位，不是在计算，而是在把世界从混沌中固定。”' },
  { name:'e', text: 'e 轻撩长发，说道：
“查得越深就越危险，但也越靠近核心。”' },
  { name:'Phi', text: 'Phi 的声音像齿轮磨过玻璃：
“500 位将打开第一扇门。你准备好了么？”' },
  { text: '你的选择出现：
A. 开始查询（主线）
B. 先问问题（世界观）
C. 停下（怀疑现实）' },

  // For players who proceed with queries, we include the original early-stage beats
  { text: '（如果你选择 A）你按下查询，数字像潮水般涌来。位数在面板上增长。' },
  { text: '（累计 100 / 200 / 300 的回合描述，影子细节逐步显现。）' },

  // CH2: 初次回音（超长扩写版）
  { text: '500 位：空气骤冷，你脚下的数字齿轮开始倒转。钟楼的阴影从四周挤压过来，像试图把你吞进去。' },
  { text: '数字雾中，一个少年的身影缓缓坐起。他的像素轮廓模糊却熟悉。' },
  { name:'零', text:'……你终于来了。'} ,
  { name:'零', text:'我不是幻觉，也不是投影。我是你——1999 年被困在 π 里的那个你。'},
  { text:'数字开始从他的胸口溢出，像被切断的代码流回到虚空。钟楼深处回响着齿轮摩擦金属的脉搏声。'},
  { name:'零', text:'被困的第一年，我记住了这里每一段循环。第二年，我开始害怕它们。第三年，我意识到……你再不来，我就永远出不去了。'},
  { text:'他抬头，眼神没有你记忆里的天真，只有深夜 debug 时的倦意与自嘲。'},
  { name:'零', text:'第 762 位，你知道那是什么吗？那是我写给未来自己的话。只是……我忘记了内容。'},
  { text:'他指向数字海洋，深处有光亮闪烁：'},
  { text:'【π 进度：500 / 10000】门扉松动了。'},
  { text:'你可以：'},
  { choices:[:[
      { text:'愿意听我说完（陪他找第762位）', action:()=>startBranch('redeem') },
      { text:'告诉他外面的真实', action:()=>startBranch('reality') },
      { text:'帮 Phi 封印他', action:()=>startBranch('betray') }
    ] },

  // Notes: subsequent chapters, deeper memories, conflicts and endings are appended dynamically by branch functions
];

VN.start(fullScript);

// ===== Player / Branch State & Debt System =====
let playerState = { branch:null, debt:0, totalQuerySim:0, redeem:0, reality:0, betray:0 };

function addQuerySim(n){ // called by outside integration if player uses query UI
  const actual = Math.max(1, Math.floor(n*0.2)); const debt = n-actual; playerState.totalQuerySim+=actual; playerState.debt+=debt; // enforce stage triggers
  if(playerState.totalQuerySim>=500 && !VN.chars['零'].visible) VN.showChar('零');
  if(playerState.totalQuerySim>=2000){ // force VN entry if not already
    // push a line to indicate entrance
    VN.currentScript.push({ text:'（查询界面碎裂，你被吸入数字海洋。）' });
    setTimeout(()=>{ VN.start(VN.currentScript); },200);
  }
}

// ===== Branches implementation (redeem/reality/betray) =====
function startBranch(name){ playerState.branch=name; if(name==='redeem') runRedeem(); if(name==='reality') runReality(); if(name==='betray') runBetray(); }

function runRedeem(){
  const s=[
    { name:'零', text:'第 762 位藏着一句话：\n“你值得被世界温柔以待。”' },
    { name:'零', text:'在 π 中，我藏了那些想对未来说的话。你会陪我找到它吗？' },
    { name:'e', text:'无限是桥梁，我会帮你。' },
    { choices:[ { text:'开始寻找第762位', action:()=>beginFind762() }, { text:'输入一句话（试试：抱抱）', action:()=>{ const v=prompt('输入一句话：'); if(v) processPlayerInput(v); } } ] }
  ];
  pushLines(s);
}

function beginFind762(){
  pushLines([
    { text:'你和零航行在数字海，位数像浪潮。' },
    { text:'你们在第 5201314 位发现一行：\n“今天也想你。”' },
    { name:'零', text:'那是给她的。但现在，我把它给你。' }
  ]);
  setTimeout(()=>{
    pushLines([{ text:'终于，第762位逐渐亮起：\n“你值得被世界温柔以待。”' }, { name:'零', text:'门开了。谢谢你。' }]);
    setTimeout(()=>playRedeemEnd(),800);
  },1200);
}

function playRedeemEnd(){
  pushLines([{ text:'白光吞没——零化作光点飞走。' }, { text:'回到查询页面，但右下角永远有个小小的零对你挥手。' }]);
}

function runReality(){
  pushLines([
    { name:'你', text:'外面也没那么好——996、房贷、社恐。' },
    { name:'零', text:'……那你还是走吧。至少你还有选择离开的自由。' },
    { text:'零戴上耳机，背对你继续计算。' }
  ]);
}

function runBetray(){
  pushLines([
    { name:'Phi', text:'愚蠢的无限，封印它。' },
    { name:'零', text:'你要把我留在这里吗？' },
    { choices:[ { text:'协助封印', action:()=>{ pushLines([{ name:'你', text:'我同意了。' }]); setTimeout(()=>playBetrayEnd(),800); } }, { text:'犹豫', action:()=>{ pushLines([{ text:'你犹豫了，空气像裂缝。' }]); } } ] }
  ]);
}

function playBetrayEnd(){
  pushLines([{ name:'Phi', text:'封印已成，你是新的守护者。' }, { text:'屏幕血红，零碎裂，页面锁死。' }]); document.body.style.pointerEvents='none'; }

// ===== Utilities =====
function pushLines(arr){ arr.forEach(l=>VN.currentScript.push(l)); if(!VN.isTyping && VN.allowNext) VN.next(); }

function processPlayerInput(v){ const s=v.toLowerCase(); if(/抱抱|hug|对不起|sorry/.test(s)){ // secret
    pushLines([{ name:'零', text:'……我等这一句等了24年。' }]); setTimeout(()=>{ triggerTrueEnding(); },900);
  } else if(/歌|歌名/.test(s)){ pushLines([{ name:'零', text:'你说的歌，像一条线，牵起了我的回忆。' }]); }
}

function triggerTrueEnding(){ pushLines([{ text:'零扑向屏幕，把你抱住。全白。' }, { text:'页面变成回家页：\n外面下雨了，一起回家吧。' }]); }

// Expose for debug
window._VN = { VN, playerState, startBranch, addQuerySim };

</script>
</body>
</html>



